language: node_js
node_js:
- '10'
cache:
  directories:
  - node_modules
before_script:
- npm install firebase-tools
- npm install
- cd server
- npm install
- cd ..
before_install:
- openssl aes-256-cbc -K $encrypted_73a2f6f70abc_key
  -in studybuddys-64d5bf7f48d8.json.enc -out studybuddys-64d5bf7f48d8.json -d
jobs:
  include:
  - stage: test
    name: Testing
    script:
    - npm test
  - stage: deploy
    name: Deploying to Firebase
    if: "(branch = master) AND (type NOT IN (pull_request))"
    script:
    - npm run build
    - firebase deploy --non-interactive --token $FIREBASE_TOKEN
  - stage: deployGAE
    name: Deploying to GAE
    if: "(branch = master) AND (type NOT IN (pull_request))"
    script:
    - cd server
    deploy:
      provider: gae
      keyfile: studybuddys-64d5bf7f48d8.json
      project: studybuddys-223920
